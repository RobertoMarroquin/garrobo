{% extends 'base.html' %}
{% load humanize %} {% load static %} {% load crispy_forms_tags %}
{% block css %}
  <!--Select2 Filter CSS-->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />

{% endblock css %}

{% block content %}
<h5 class="text-center">{{libro.cliente.nombre}}</h5>
<h5 class="text-center">Facturas de Compras {{libro.get_mes_display}}/{{libro.ano}}</h5>
<hr>
<br>
<!------------------------------------------------------------------------------------------->
<!------------------------------------------------------------------------------------------->

<div class="row">
    <div class="col-md-2">
        <a name="" id="" class="btn btn-primary" href="{% url 'iva:lista_libro' libro.cliente.id libro.tipo %}"
            role="button">Libros</a>
    </div>
    <div class="col-md-4"></div>
    <div class="col-md-2"></div>
    <div class="col-md-2">
        <a name="" id="" class="btn btn-primary" href="{% url 'iva:retencion' libro.id %}"
            role="button">Retenciones</a>
    </div>
    <div class="col-md-2">
        <a name="" id="" class="btn btn-success" href="{% url 'iva:nueva_empresa2' libro.id %}"
            role="button">Nuevo Registro</a>
    </div>
</div>
<!------------------------------------------------------------------------------------------->
<!------------------------------------------------------------------------------------------->
<div class="container">
    <form action="" method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-4">
                {{form.empresa|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.fecha|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.claseDocumento|as_crispy_field}}
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                {{form.tipoDocumento|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.numeroDocumento|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.cExenteInterna|as_crispy_field}}
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                {{form.cExenteInternaciones|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.cExenteImportaciones|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.cGravadaInterna|as_crispy_field}}
            </div>
        </div> 
        <div class="row">
            <div class="col-md-4">
                {{form.cGravadaInternaciones|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.cGravadaImportaciones|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.cGravadaImportacionesServicios|as_crispy_field}}
            </div>
        </div> 
        <div class="row">
            <div class="col-md-4">
                {{form.ivaCdtoFiscal|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.totalCompra|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.retencionPretencion|as_crispy_field}}
            </div>
        </div> 
        <div class="row">
            <div class="col-md-4">
                {{form.anticipoCtaIva|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.ivaTerceros|as_crispy_field}}
            </div>
            <div class="col-md-4">
                {{form.numeroSerie|as_crispy_field}}
            </div>
        </div> 
        <div class="row text center">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </div>
        
    </form>
</div>
<!------------------------------------------------------------------------------------------->
<!------------------------------------------------------------------------------------------->
<div class="container">
    <div class="table-responsive">
        <table id="tabla1" class="table table-striped table-sm">
            <caption>Facturas Registradas</caption>
            <thead class="thead-dark">
                <tr class="text-center">
                <th class="align-middle">Empresa</th>
                <th class="align-middle">NIT</th>
                <th class="align-middle">Fecha</th>
                <th class="align-middle">Clase de Doc</th>
                <th class="align-middle">Tipo de Doc</th>
                <th class="align-middle">Numero de Doc</th>
                <th class="align-middle">Comp Loc Exen</th>
                <th class="align-middle">Inter Exen</th>
                <th class="align-middle">Impor Exen</th>
                <th class="align-middle">Comp Loc Grav</th>
                <th class="align-middle">Inter Grav Bienes</th>
                <th class="align-middle">Impor Grav Bienes</th>
                <th class="align-middle">Impor Grav Servicios</th>
                <th class="align-middle">Crdto Fiscal</th>
                <th class="align-middle">Total Compra</th>
                <th class="align-middle">Retencion/Pretencion</th>
                <th class="align-middle">Anticipo Cta Iva</th>
                <th class="align-middle">Numero de Serie</th>
                <th class="align-middle">IVA Terceros</th>

            </tr>
            </thead>
            <tbody>
                {% for factura in facturas.all|dictsort:"fecha"  %}
                
                {% if factura.empresa.nit is None %}
                <tr class="text-center table-warning">    
                {% else %}
                <tr class="text-center">                    
                {% endif %}
                        <td class="align-middle">{{factura.empresa}}</td>
                        <td class="align-middle">{{factura.empresa.nit}}</td>
                        <td class="align-middle">{{factura.fecha}}</td>
                        <td class="align-middle">{{factura.claseDocumento}}</td>
                        <td class="align-middle">{{factura.tipoDocumento}}</td>
                        <td class="align-middle">{{factura.numeroDocumento}}</td>
                        <td class="align-middle">{{factura.cExenteInterna}}</td>
                        <td class="align-middle">{{factura.cExenteInternaciones}}</td>
                        <td class="align-middle">{{factura.cExenteImportaciones}}</td>
                        <td class="align-middle">{{factura.cGravadaInterna}}</td>
                        <td class="align-middle">{{factura.cGravadaInternaciones}}</td>
                        <td class="align-middle">{{factura.cGravadaImportaciones}}</td>
                        <td class="align-middle">{{factura.cGravadaImportacionesServicios}}</td>
                        <td class="align-middle">{{factura.ivaCdtoFiscal}}</td>
                        <td class="align-middle">{{factura.totalCompra}}</td>
                        <td class="align-middle">{{factura.retencionPretencion}}</td>
                        <td class="align-middle">{{factura.anticipoCtaIva}}</td>
                        <th class="align-middle">{{factura.numeroSerie}}</th>
                        <td class="align-middle">{{factura.ivaTerceros}}</td>
                    </tr>
                {% empty %}
                <tr class="text-center">
                    <td colspan=17 class="align-middle">No hay registros</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock content %}
{% block extrajs %}
  <!--Select2 Filter JS-->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $("#id_empresa").select2();
            $('#id_empresa').show().focus().click();
        })

        $(document).change(()=>{
            $("#id_ivaCdtoFiscal").val(((
                parseFloat($("#id_cGravadaInterna").val()) +
                parseFloat($("#id_cGravadaInternaciones").val()) +
                parseFloat($("#id_cGravadaImportaciones").val()) +
                parseFloat($("#id_cGravadaImportacionesServicios").val()) 
            ) * 0.13).toFixed(2))

            $("#id_totalCompra").val((
                parseFloat($("#id_cExenteInterna").val()) +
                parseFloat($("#id_cExenteInternaciones").val()) +
                parseFloat($("#id_cExenteImportaciones").val()) +
                parseFloat($("#id_cGravadaInterna").val()) +
                parseFloat($("#id_cGravadaInternaciones").val()) +
                parseFloat($("#id_cGravadaImportaciones").val()) +
                parseFloat($("#id_cGravadaImportacionesServicios").val()) +
                parseFloat($("#id_ivaCdtoFiscal").val()) +
                parseFloat($("#id_retencionPretencion").val()) +
                parseFloat($("#id_anticipoCtaIva").val()) +
                parseFloat($("#id_ivaTerceros").val())
            ).toFixed(2))
        })
       
    </script>
{% endblock extrajs %}